<html>
<title>View Experiment Data</title>
<body>
<div id="filebrowser"></div>


<script type="text/javascript">

//2012-04-06 custom script written by Mark Igra to directly bounce into experiment folder without loading entire webdav filesystem. 
//modified here to take input from url substitution from experiment grid instead of popup menu

function ensureExperimentFolder(folderId, callback) {
   var baseUrl = LABKEY.contextPath + '/_webdav' +window.encodeURI(LABKEY.container.path + '/@files/');
   var folderUrl = baseUrl + folderId +  '?method=PROPFIND';
   Ext.Ajax.request({url:folderUrl, success:callback, 
      failure:function() {
      var fileSystem = new LABKEY.FileSystem.WebdavFileSystem({baseUrl:baseUrl});

      fileSystem.createDirectory(folderId, callback);
      }
   });
}

</script>

<script type="text/javascript">

function renderBrowser(rootPath, renderTo, isFolderTreeCollapsed, isPipelineRoot)
{
    var autoResize = false;

    var buttonActions = [];

        
        buttonActions.push('parentFolder');
    
        buttonActions.push('refresh');
    
        buttonActions.push('createDirectory');
    
        buttonActions.push('download');
    
        buttonActions.push('deletePath');
    
        buttonActions.push('editFileProps');
    
        buttonActions.push('upload');
    
        buttonActions.push('importData');
    
        buttonActions.push('emailPreferences');
    
 
    var fileSystem = new LABKEY.FileSystem.WebdavFileSystem({
        extraPropNames: ['description', 'actions'],

        // extra props should model Ext.data.Field types
        extraDataFields: [
            {name: 'description', mapping: 'propstat/prop/description'},
            {name: 'actionHref', mapping: 'propstat/prop/actions', convert : function (v, rec)
                {
                    var result = [];
                    var actionsElements = Ext.DomQuery.compile('propstat/prop/actions').call(this, rec);
                    if (actionsElements.length > 0)
                    {
                        var actionElements = actionsElements[0].getElementsByTagName('action');
                        for (var i = 0; i < actionElements.length; i++)
                        {
                            var action = new Object();
                            var childNodes = actionElements[i].childNodes;
                            for (var n = 0; n < childNodes.length; n++)
                            {
                                var childNode = childNodes[n];
                                if (childNode.nodeName == 'message')
                                {
                                    action.message = childNode.textContent || childNode.text;
                                }
                                else if (childNode.nodeName == 'href')
                                {
                                    action.href = childNode.textContent || childNode.text;
                                }
                            }
                            result[result.length] = action;
                        }
                    }
                    return result;
                }}
        ],
        baseUrl:rootPath,
        rootName:'fileset'
    });

    var prefix = undefined;

    

    var fileBrowser = new LABKEY.FilesWebPartPanel({
        fileSystem: fileSystem,
        helpEl:null,
        resizable: false,
        showAddressBar: true,
        showFolderTree: false,
        folderTreeCollapsed: true,
        expandFileUpload: true,
        disableGeneralAdminSettings: false,
        showProperties: false,
        showDetails: false,
        allowChangeDirectory: true,
        tbarItems: buttonActions,
        isPipelineRoot: isPipelineRoot,
        adminUser : true,
        statePrefix: prefix
    });

    var panel = new Ext.Panel({
        layout: 'fit',
        renderTo: renderTo,
        border: false,
        items: [fileBrowser],
        height: 350,
        boxMinHeight:350,
        boxMinWidth: 650
    });

    var _resize = function(w,h)
    {
        LABKEY.Utils.resizeToViewport(panel, w, h);
    };

    if (autoResize)
    {
        Ext.EventManager.onWindowResize(_resize);
        Ext.EventManager.fireWindowResize();
    }

    fileBrowser.start();
}


        var scripts =['applet.js','FileUploadField.js', 'StatusBar.js','fileBrowser.js',
            'Reorderer.js',
            'ToolbarDroppable.js',
            'ToolbarReorderer.js',
            'ActionsAdmin.js',
            'PipelineAction.js',
            'FileProperties.js',
            'FileContent.js'];

        LABKEY.requiresScript(scripts,
                function(){
                    Ext.onReady(function(){

                        /**
                         * activate the Ext state manager (for directory persistence), but by default, make all components
                         * not try to load state.
                         */
                        Ext.state.Manager.setProvider(new Ext.state.CookieProvider());
                        Ext.override(Ext.Component,{
                            stateful:false
                        });

                        Ext.BLANK_IMAGE_URL = LABKEY.contextPath + "/_.gif";
                        Ext.QuickTips.init();
                        
//here is where i pass the experiment number from the url substitution

                    var folderId = LABKEY.ActionURL.getParameter('experimentId');

		    ensureExperimentFolder(folderId, function () {
			   var baseUrl = LABKEY.contextPath + '/_webdav' +window.encodeURI(LABKEY.container.path + '/@files/' + folderId);

                        renderBrowser(baseUrl, 'filebrowser', true, false);
});
                    });
                },
                this,
                true);


Ext4.onReady( function () {
	var expNum = LABKEY.ActionURL.getParameter('experimentId');
	document.getElementById("labkey-nav-trail-current-page").innerHTML = "Experiment " + expNum + " Details";
	
	LABKEY.Query.selectRows({
        schemaName: 'oconnor',
        queryName: 'simple_experiment',
        columns: ['created', 'expNumber', 'expDescription', 'expParent', 'expType', 'expComments', 'initials'],
        filterArray: [LABKEY.Filter.create('expNumber', expNum, LABKEY.Filter.Types.EQUAL)],
        success: onSuccess,
    });
    	
// 	LABKEY.Query.selectRows({
// 		containerPath: '/dho/gs',
//         schemaName: 'lists',
//         queryName: 'analysis_experiments',
//         columns: ['analysis'],
//         filterArray: [LABKEY.Filter.create('experiment', expNum, LABKEY.Filter.Types.EQUAL)],
//         success: analysis454,
//     });
});

function onSuccess(data) {
	var parents = new Array();
	var expNum = LABKEY.ActionURL.getParameter('experimentId');
	var expInfo = new Array(data.rows[0].expComments, data.rows[0].expDescription, data.rows[0].created, data.rows[0].initials, data.rows[0].expType, data.rows[0].expParent);
	var expInfoNames = new Array("Details", "Summary", "Date Created", "Created By", "Experiment Type", "Experiment Parent(s)");
	if (expInfo[5] != null){
		var commaParents = expInfo[5].replace(/;/g, ',');
		var noSpace = commaParents.replace(/\s/g, '');
		console.log(noSpace);
		parents = noSpace.split(",");		
		parents.sort();
		console.log(parents.length);
	}
	var tableHtml = '<table><col width="150">'
	for(var i=1;i<expInfo.length;i++){
		if(expInfo[i] == null){
			expInfo[i] = '';
		}
		tableHtml = tableHtml + '<tr><td class="labkey-form-label">' + expInfoNames[i] + '</td><td colspan=1>' + expInfo[i] + '</td>';
//		Annoying buggy code, will come back to later
// 		if (expInfoNames[i] != "Experiment Parent(s)") {		
// 			tableHtml = tableHtml + '<tr><td class="labkey-form-label">' + expInfoNames[i] + '</td><td colspan=1>' + expInfo[i] + '</td>';
// 		} else {
// 			tableHtml = tableHtml + '<tr><td class="labkey-form-label">' + expInfoNames[i] + '</td><td colspan=1>';
// 			if (parents.length > 0) {
// 				for (var i=0; i<parents.length; i++){
// 					console.log("round" + i);
// 					tableHtml = tableHtml + '<a href="' + '/oconnor' + LABKEY.container.path + '/experiments_files.view?experimentId=' + parents[i] + '">' + parents[i] + '</a>';
// 					if (i<(parents.length-1)){ tableHtml = tableHtml + ', ';}
// 				}
// 			}
// 		tableHtml = tableHtml + '</td>';
// 		}
	}
	tableHtml = tableHtml + '</table>';
	
	document.getElementById('filebrowser').innerHTML = tableHtml;

	var expDetails = Ext4.create('Ext.container.Container',{
		title: 'Experiment Details',
		padding: 5,
		html: expInfo[0],
	});
	var editButton = Ext4.create('Ext.Button',{
		text: 'Edit',
		handler: function() {window.location='/oconnor' + LABKEY.container.path + '/experimentUpdate.view?experimentId=' + expNum}
	});
	var showGridButton = Ext4.create('Ext.Button',{
		text: 'Show Grid',
		handler: function() {window.location = '/oconnor' + LABKEY.container.path + '/experiments.view?';}
	});
	var printButton = Ext4.create('Ext.Button',{
		text: 'Print',
		handler: function () {var printWindow = window.open(location.href + '&_print=1'); setTimeout(function(){var printTimeout = printWindow.print(); printWindow.close();}, 2000);}
	});

	var buttonGroup = Ext4.create('Ext.container.Container', {
		itemId: 'buttonGroup',
		layout: {type: 'hbox'},
		defaults:{
			margin: '5 5 30 0'
		},
		bodyPadding: '5px',
		width: 200,
		items: [editButton, showGridButton, printButton],
		//renderTo: 'filebrowser'
	});
	var expSubPanel = Ext4.create('Ext.panel.Panel',{
		layout: 'fit',
        border: false,
        items: [expDetails,buttonGroup],
	});

	var expInfoPanel = Ext4.create('Ext.panel.Panel',{
		id: 'expInfoPanel',
		layout: 'fit',
        renderTo: 'filebrowser',
        border: false,
        items: [expSubPanel],
        boxMinWidth: 650
	});

}
f// unction analysis454(analysisData){
// 	var analysisNum = analysisData.rows[0].analysis
// 	var analysisHtml = '<table><col width="150">'
// 	if(analysisNum != null){
// 		analysisHtml = analysisHtml + '<tr><td class="labkey-form-label">454 Analysis</td><td colspan=1><a href="/genotyping/dho/gs/analysis.view?analysis=' + analysisNum +'">' + analysisNum + '</a></td>';
// 	}
// 	analysisHtml = analysisHtml + '</table>';
// 	//document.getElementById('filebrowser').innerHTML = analysisHtml;
// 	Ext.getCmp('expInfoPanel').add(analysisHtml);
// }
</script>
</body>
</html>